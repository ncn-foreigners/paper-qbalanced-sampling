## example with diamonds

diamonds$pik <- inclusionprobabilities(diamonds$carat, 1000)
diamonds$cut <- as.character(diamonds$cut)
diamonds$color <- as.character(diamonds$color)
diamonds$clarity <- as.character(diamonds$clarity)


Xs <- model.matrix(~carat + cut + color + clarity + x + y + z, diamonds)
dd  <- cube(diamonds$pik, Xs)
#dd  <- SamplingBigData::lpm2_kdtree(diamonds$pik, Xs)
Xs_sel <- Xs[dd, ]
colMeans(Xs)-colMeans(Xs_sel/diamonds$pik[dd])
